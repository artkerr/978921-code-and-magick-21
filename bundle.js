(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/code-and-magick/data",t="https://21.javascript.pages.academy/code-and-magick";window.backend={load:(t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?t(o.response):n(`Статус ответа:  ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{n(`Запрос не успел выполниться за ${o.timeout}мс`)})),o.timeout=1e4,o.open("GET",e),o.send()},save:(e,n,o)=>{const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(()=>{200===r.status?n(r.response):o(`Статус ответа:  ${r.status} ${r.statusText}`)})),r.open("POST",t),r.send(e)}}})(),(()=>{let e=null;window.debounce=function(t){e&&window.clearTimeout(e),e=window.setTimeout(t,300)}})(),(()=>{const e=["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],t=["black","red","blue","yellow","green"],n=["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"],o=document.querySelector(".setup-player"),r=o.querySelector(".wizard-coat"),a=o.querySelector(".wizard-eyes"),l=o.querySelector('[name="coat-color"]'),s=o.querySelector('[name="eyes-color"]'),i=o.querySelector('[name="fireball-color"'),d=o.querySelector(".setup-fireball-wrap");let c={onCoatChange:e=>e,onEyesChange:e=>e,onFireBallChange:e=>e};r.addEventListener("click",(()=>{window.setWizardColor(r,l,e),c.onCoatChange(l.value)})),a.addEventListener("click",(()=>{window.setWizardColor(a,s,t),c.onEyesChange(s.value)})),d.addEventListener("click",(()=>{window.setWizardColor(d,i,n),c.onFireBallChange(i.value)})),window.wizard={setCoatChangeHandler:e=>{c.onCoatChange=e},setEyesChangeHandler:e=>{c.onEyesChange=e},setFireBallChangeHandler:e=>{c.onFireBallChange=e}}})(),(()=>{const e=document.querySelector("#similar-wizard-template").content,t=document.querySelector(".setup-similar");t.classList.remove("hidden");const n=t.querySelector(".setup-similar-list"),o=t=>{const n=e.cloneNode(!0);return n.querySelector(".setup-similar-label").textContent=t.name,n.querySelector(".wizard-coat").style.fill=t.colorCoat,n.querySelector(".wizard-eyes").style.fill=t.colorEyes,n};window.render=e=>{const t=document.createDocumentFragment();n.innerHTML="";for(let n=0;n<4;n++)t.appendChild(o(e[n]));n.appendChild(t)}})(),(()=>{const e=(e,t,n,o)=>{e.fillStyle=o,e.fillRect(t,n,420,270)},t=(e,t,n,o)=>{e.fillStyle="#000",e.font="16px PT Mono",e.textBaseline="hanging",e.fillText(t,n,o)};window.renderStatistics=function(n,o,r){e(n,110,20,"rgba(0, 0, 0, 0.7)"),e(n,100,10,"#fff"),t(n,"Ура вы победили!",120,30),t(n,"Список результатов:",120,50);const a=Math.round((l=r,Math.max.apply(null,l)));var l;for(let e=0;e<o.length;e++)n.fillStyle="#000",n.fillText(o[e],140+90*e,250),n.fillText(Math.round(r[e]),140+90*e,220-150*r[e]/a),n.fillStyle="Вы"===o[e]?"rgba(255, 0, 0, 1":`hsla(231, 90%, ${Math.round(60*Math.random())+20}%, 1)`,n.fillRect(140+90*e,240,40,-150*r[e]/a)}})(),window.util={isEscEvt:(e,t)=>{"Escape"===e.key&&t()},isEnterEvt:(e,t)=>{"Enter"===e.key&&t()},createErrorMessage:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e=document.querySelector(".setup"),t=document.querySelector(".setup-open-icon"),n=e.querySelector(".setup-close"),o=document.querySelector(".setup-user-name"),r=e=>{document.activeElement!==o&&window.util.isEscEvt(e,l)},a=()=>{e.classList.remove("hidden"),document.addEventListener("keydown",r)},l=()=>{e.classList.add("hidden"),document.removeEventListener("keydown",r)};t.addEventListener("click",(()=>{a()})),t.addEventListener("keydown",(e=>{window.util.isEnterEvt(e,a)})),n.addEventListener("click",(()=>{l()})),n.addEventListener("keydown",(e=>{window.util.isEnterEvt(e,l)}));const s=e.querySelector(".upload");s.addEventListener("mousedown",(function(t){t.preventDefault();let n={x:t.clientX,y:t.clientY},o=!1;const r=function(t){t.preventDefault(),o=!0;const r=n.x-t.clientX,a=n.y-t.clientY;n={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-a+"px",e.style.left=e.offsetLeft-r+"px"},a=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a),o){const e=function(t){t.preventDefault(),s.removeEventListener("click",e)};s.addEventListener("click",e)}};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}))})(),(()=>{const e=document.querySelector(".setup-user-name");e.addEventListener("invalid",(()=>{e.validity.tooShort?e.setCustomValidity("Имя персонажа не может содержать менее 2 символов"):e.validity.tooLong?e.setCustomValidity("Максимальная длина имени персонажа — 25 символов"):e.validity.valueMissing?e.setCustomValidity("Обязательное поле"):e.setCustomValidity("")}))})(),window.setWizardColor=(e,t,n)=>{const o=(e=>e[Math.floor(Math.random()*e.length)])(n);e.matches(".setup-fireball-wrap")&&(e.style.backgroundColor=o),e.style.fill=o,t.value=o},(()=>{let e="rgb(101, 137, 164)",t="black",n=[];const o=function(n){let o=0;return n.colorCoat===e&&(o+=2),n.colorEyes===t&&(o+=1),o},r=function(){window.render(n.sort((function(e,t){let n=o(t)-o(e);return 0===n&&(n=function(e,t){return e>t?1:e<t?-1:0}(e.name,t.name)),n})))};window.wizard.setCoatChangeHandler((t=>{e=t,window.debounce(r)})),window.wizard.setEyesChangeHandler((e=>{t=e,window.debounce(r)})),window.backend.load((e=>{n=e,window.debounce(r)}),(e=>{window.util.createErrorMessage(e)}));const a=document.querySelector(".setup"),l=a.querySelector(".setup-wizard-form");l.addEventListener("submit",(function(e){window.backend.save(new FormData(l),(()=>{a.classList.add("hidden")})),e.preventDefault()}))})()})();